generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  lucien_admin
  lucien_operator
  org_admin
  org_user
}

enum InquiryStatus {
  new
  triaged
  converted
  closed
}

enum EngagementStage {
  triage
  scope_pack
  sow
  delivery
  handover
  ongoing
  closed
}

enum EngagementStatus {
  on_track
  at_risk
  blocked
  completed
}

enum DocumentCategory {
  nda
  sow
  contract
  deliverable
  report
  invoice
  client_input
  evidence
  other
}

enum MilestoneStatus {
  planned
  in_progress
  complete
}

enum DeliverableStatus {
  draft
  review
  approved
}

enum ScopeStatus {
  draft
  sent
  approved
  rejected
}

enum ChangeImpact {
  scope
  schedule
  cost
  risk
}

enum ChangeSeverity {
  low
  med
  high
}

enum ChangeStatus {
  proposed
  needs_info
  approved
  rejected
  implemented
  cancelled
}

enum EditEntityType {
  engagement
  scope
  change_request
  invoice
  document
  deliverable
  milestone
}

enum EditKind {
  minor_edit
  controlled_edit
  archive
  supersede
}

enum EditStatus {
  applied
  pending_approval
  rejected
}

model Org {
  id         String       @id @default(cuid())
  name       String       @unique
  domain     String?
  createdAt  DateTime     @default(now())
  users      User[]
  inquiries  Inquiry[]
  engagements Engagement[]
  documents  Document[]
  milestones Milestone[]
  deliverables Deliverable[]
  scopeProposals ScopeProposal[]
  changeRequests ChangeRequest[]
  invoices Invoice[]
  notifications Notification[]
  auditEvents AuditEvent[]
  editEvents EditEvent[]
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  role          UserRole   @default(org_user)
  orgId         String
  createdAt     DateTime   @default(now())
  lastLoginAt   DateTime?
  emailVerified DateTime?
  onboardedAt   DateTime?
  onboardingData Json?

  org        Org       @relation(fields: [orgId], references: [id])
  accounts   Account[]
  sessions   Session[]
  documents  Document[] @relation("UploadedDocuments")
  auditEvents AuditEvent[]
  ownedEngagements Engagement[] @relation("EngagementOwner")
  approvedDeliverables Deliverable[] @relation("DeliverableApprover")
  scopeProposals ScopeProposal[] @relation("ScopeProposalAuthor")
  createdChangeRequests ChangeRequest[] @relation("ChangeRequestCreator")
  assignedChangeRequests ChangeRequest[] @relation("ChangeRequestAssignee")
  notifications Notification[]
  editEvents EditEvent[] @relation("EditEventCreator")
  archivedDocuments Document[] @relation("DocumentArchivist")

  @@index([orgId])
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Service {
  id                 String    @id @default(cuid())
  slug               String    @unique
  sku                String    @unique
  title              String
  pricingModel       String
  priceFrom          Int?
  currency           String
  depositAmountCents Int?
  deliveryWindow     String
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  inquiries          Inquiry[]
  orders             Order[]
}

model Customer {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  organization String
  role         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  inquiries    Inquiry[]
  orders       Order[]
}

model Inquiry {
  id           String        @id @default(cuid())
  orgId        String
  organization String
  contactName  String?
  contactEmail String
  role         String?
  emailHash    String
  serviceSlug  String
  timeframe    String
  note         String?
  mode         String?
  message      String?
  engagement   String?
  timeline     String?
  purchaseType String?
  status       InquiryStatus @default(new)
  source       String?
  consent      Boolean       @default(false)
  utmSource    String?
  utmMedium    String?
  utmCampaign  String?
  utmTerm      String?
  utmContent   String?
  createdAt    DateTime      @default(now())
  serviceId    String?
  customerId   String?

  org      Org       @relation(fields: [orgId], references: [id])
  service  Service?  @relation(fields: [serviceId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  engagementRecord Engagement?
  scopeProposals ScopeProposal[]
  documents Document[]

  @@index([orgId])
  @@index([status])
}

model Engagement {
  id            String           @id @default(cuid())
  orgId         String
  title         String
  serviceSlug   String?
  stage         EngagementStage  @default(triage)
  status        EngagementStatus @default(on_track)
  startDate     DateTime?
  targetDate    DateTime?
  procurementRef String?
  purchaseOrderRef String?
  costCenter    String?
  ownerId       String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  inquiryId     String?          @unique

  org       Org      @relation(fields: [orgId], references: [id])
  inquiry   Inquiry? @relation(fields: [inquiryId], references: [id])
  owner     User?    @relation("EngagementOwner", fields: [ownerId], references: [id])
  documents Document[]
  milestones Milestone[]
  deliverables Deliverable[]
  scopeProposals ScopeProposal[]
  changeRequests ChangeRequest[]
  invoices Invoice[]

  @@index([orgId])
}

model Document {
  id               String           @id @default(cuid())
  orgId            String
  engagementId     String?
  inquiryId        String?
  category         DocumentCategory
  name             String
  label            String?
  description      String?
  mimeType         String
  size             Int
  checksum         String?
  storageKey       String
  createdAt        DateTime         @default(now())
  uploadedByUserId String?
  archivedAt       DateTime?
  archivedByUserId String?
  archiveReason    String?

  org         Org         @relation(fields: [orgId], references: [id])
  engagement  Engagement? @relation(fields: [engagementId], references: [id])
  inquiry     Inquiry?    @relation(fields: [inquiryId], references: [id])
  uploadedBy  User?       @relation("UploadedDocuments", fields: [uploadedByUserId], references: [id])
  archivedBy  User?       @relation("DocumentArchivist", fields: [archivedByUserId], references: [id])
  deliverable Deliverable?

  @@index([orgId])
  @@index([engagementId])
  @@index([inquiryId])
}

model AuditEvent {
  id           String   @id @default(cuid())
  orgId        String
  userId       String?
  action       String
  resourceType String
  resourceId   String?
  metaJson     String?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  org  Org   @relation(fields: [orgId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt])
}

model ChangeRequest {
  id               String         @id @default(cuid())
  orgId            String
  engagementId     String
  createdByUserId  String
  assignedToUserId String?
  title            String
  description      String
  impact           ChangeImpact
  severity         ChangeSeverity
  status           ChangeStatus   @default(proposed)
  requestedAt      DateTime       @default(now())
  decidedAt        DateTime?
  implementedAt    DateTime?
  decisionNote     String?
  costDeltaEUR     Int?
  scheduleDeltaDays Int?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  org         Org        @relation(fields: [orgId], references: [id])
  engagement  Engagement @relation(fields: [engagementId], references: [id])
  createdBy   User       @relation("ChangeRequestCreator", fields: [createdByUserId], references: [id])
  assignedTo  User?      @relation("ChangeRequestAssignee", fields: [assignedToUserId], references: [id])
  editEvents  EditEvent[]

  @@index([orgId])
  @@index([engagementId])
  @@index([status])
}

model Invoice {
  id              String        @id @default(cuid())
  orgId           String
  engagementId    String?
  scopeProposalId String?
  invoiceNumber   String?
  internalNote    String?
  issueDate       DateTime?
  dueDate         DateTime?
  paidAt          DateTime?
  referencePO     String?
  currency        String        @default("EUR")
  amountEUR       Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  org           Org            @relation(fields: [orgId], references: [id])
  engagement    Engagement?    @relation(fields: [engagementId], references: [id])
  scopeProposal ScopeProposal? @relation(fields: [scopeProposalId], references: [id])

  @@index([orgId])
  @@index([engagementId])
}

model Milestone {
  id           String          @id @default(cuid())
  orgId        String
  engagementId String
  title        String
  dueDate      DateTime?
  status       MilestoneStatus @default(planned)
  order        Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  org        Org        @relation(fields: [orgId], references: [id])
  engagement Engagement @relation(fields: [engagementId], references: [id])

  @@index([orgId])
  @@index([engagementId])
}

model Deliverable {
  id            String           @id @default(cuid())
  orgId         String
  engagementId  String
  title         String
  status        DeliverableStatus @default(draft)
  documentId    String?          @unique
  approvedAt    DateTime?
  approvedById  String?
  approvalNote  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  org        Org        @relation(fields: [orgId], references: [id])
  engagement Engagement @relation(fields: [engagementId], references: [id])
  document   Document?  @relation(fields: [documentId], references: [id])
  approvedBy User?      @relation("DeliverableApprover", fields: [approvedById], references: [id])

  @@index([orgId])
  @@index([engagementId])
}

model ScopeProposal {
  id             String      @id @default(cuid())
  orgId          String
  inquiryId      String?
  engagementId   String?
  title          String
  fixedPriceEUR  Int
  scopeSummary   String
  deliverablesJson Json
  status         ScopeStatus @default(draft)
  clientNote     String?
  createdById    String?
  sentAt         DateTime?
  approvedAt     DateTime?
  rejectedAt     DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  org        Org        @relation(fields: [orgId], references: [id])
  inquiry    Inquiry?   @relation(fields: [inquiryId], references: [id])
  engagement Engagement? @relation(fields: [engagementId], references: [id])
  createdBy  User?      @relation("ScopeProposalAuthor", fields: [createdById], references: [id])
  invoices   Invoice[]

  @@index([orgId])
  @@index([inquiryId])
  @@index([engagementId])
}

model Notification {
  id              String   @id @default(cuid())
  orgId           String
  recipientUserId String
  type            String
  title           String
  body            String
  entityType      String?
  entityId        String?
  readAt          DateTime?
  createdAt       DateTime @default(now())

  org      Org  @relation(fields: [orgId], references: [id])
  recipient User @relation(fields: [recipientUserId], references: [id])

  @@index([orgId])
  @@index([recipientUserId, readAt])
}

model EditEvent {
  id                    String         @id @default(cuid())
  orgId                 String
  entityType            EditEntityType
  entityId              String
  createdByUserId       String
  kind                  EditKind
  status                EditStatus
  reason                String
  diffJson              Json
  linkedChangeRequestId String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  org                Org            @relation(fields: [orgId], references: [id])
  createdBy          User           @relation("EditEventCreator", fields: [createdByUserId], references: [id])
  linkedChangeRequest ChangeRequest? @relation(fields: [linkedChangeRequestId], references: [id])

  @@index([orgId, createdAt])
  @@index([entityType, entityId])
}

model Order {
  id                   String    @id @default(cuid())
  serviceId            String?
  customerId           String?
  status               String
  purchaseType         String
  amountCents          Int
  currency             String
  stripeSessionId      String?
  stripePaymentIntentId String?
  receiptToken         String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  service  Service?  @relation(fields: [serviceId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  payments Payment[]
}

model Payment {
  id                   String   @id @default(cuid())
  orderId              String
  status               String
  provider             String
  amountCents          Int
  currency             String
  stripePaymentIntentId String?
  stripeSessionId      String?
  stripeEventId        String?  @unique
  createdAt            DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id])
}
